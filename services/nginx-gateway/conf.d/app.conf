# Use Docker's internal DNS resolver
resolver 127.0.0.11 ipv6=off;

server {
    listen 8080;
    
    # Health checks
    location /healthz {
        access_log off;
        default_type application/json;
        return 200 '{"status":"ok"}';
    }
    
    location /readyz {
        access_log off;
        default_type application/json;
        return 200 '{"status":"ready"}';
    }

    # Frontend
    location / {
        proxy_pass http://frontend:5173;
        include /etc/nginx/includes/proxy.conf;
    }

    # Auth Service Routes
    location ~ ^/api/(login|register|refresh|logout)$ {
        include /etc/nginx/includes/cors.conf;
        include /etc/nginx/includes/proxy.conf;
        
        access_by_lua_block {
            dofile("/etc/nginx/lua/auth.lua")
            dofile("/etc/nginx/lua/sign.lua")
        }
        
        rewrite ^/api/(.*) /api/auth/$1 break;
        proxy_pass http://user-management:8000;
    }
    
    # Dashboard Routes
    location /api/dashboard/ {
        include /etc/nginx/includes/cors.conf;
        include /etc/nginx/includes/proxy.conf;

        access_by_lua_block {
            dofile("/etc/nginx/lua/auth.lua")
            dofile("/etc/nginx/lua/sign.lua")
        }
        
        rewrite ^/api/dashboard/(.*) /dashboards/$1 break;
        proxy_pass http://analytics-service:9000;
    }
    
    # Notification Routes
    location /api/notifications/ {
        include /etc/nginx/includes/cors.conf;
        include /etc/nginx/includes/proxy.conf;

        access_by_lua_block {
            dofile("/etc/nginx/lua/auth.lua")
            dofile("/etc/nginx/lua/sign.lua")
        }
        
        rewrite ^/api/notifications/(.*) /notifications/$1 break;
        proxy_pass http://notifications-service:9100;
    }
}
